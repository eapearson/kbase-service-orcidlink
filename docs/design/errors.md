# Errors

> in progress 
 
Two types of errors may be encountered: api and interaction

API errors are by far the most numerous. They may occur during any API call to this service. They follow schema that is documented below. With API errors, the front end (browser) will detect the error and display it in a uniform manner.

Interaction errors occur during linking when the OAuth flow requires that the browser  follow links to this service and to ORCID. These errors cannot be captured by the front end code, since the "front end" is provided by this service. However, that "front end" is only meant to be interstitial -- that is, it is not meant to be displayed to the user but rather immediately redirects to the ORCID Link front end. Errors encountered in this interstitial process are reported to the user by way of a redirect containing query parameters with the error information. The front end hosts a view (page) which displays the error information contained in this url.

All unique errors or types of errors are identified by an error code. The identifiers are cataloged in the codebase to ease diagnosis, and also may be located in the codebase.

Error ids are strings.

## Interactive Errors

| Code                    | Type        | Message                                                      | Description         |
| ----------------------- | ----------- | ------------------------------------------------------------ | ------------------- |
| link.orcid_error        | interactive | variable                                                     | some error at ORCID |
| link.code_missing       | interactive | The 'code' query param is required but missing               |                     |
| link.state_missing      | interactive | The 'state' query param is required but missing              | oauth misuse        |
| link.session_id_missing | interactive | The 'session_id' was not provided in the 'state' query param | internal error      |

Interactive errors are conveyed by a redirect (302) from the ORCIDLink service to the ui endpoint `f"{config().linking_session_return_url}/error"`. The url provides the error information in the following fields of the query params:

- `code` - the error code as described above

- `title`- a short phrase describing the error, suitable for an error message title; just one or a few words

- `message`- the full text of the error message to be displayed to the end user

### link.state_missing

This may occur if the continue redirection from ORCID does not contain the required "state" parameter

### link.session_id_missing

This could occur if the session created by the ORCIDLink service does not contain a session id; this would indicate an internal programming error



## API Errors

API errors are consumed directly by the ORCID Link UI. They are HTTP responses, which carry an HTTP response code, a `Content-Type` HTTP header field with value `application/json`, and a response body in JSON encoding.

Most such errors, those generated by the ORCID Link codebase, provide the same fields as interactive errors - code, title, message. In addition, an API error may provide a `data` field which carries arbitrary JSON data further describing the error. A common data field provides a `backtrace` field containing a the Python backtrace as an array of strings.

## Incorrect API usage vs real situations

There is no inherent way to distinguish between incorrect usage of an API and errors
which occur under natural conditions. We need to encode that distinction in the API call
handling.

For instance, authorization errors come in different flavors.

A programmer may forget to send the Authorization header, or set it to an invalid value.
The first results in a 403 (which is wrong, btw) with text/html. The second a 401 with an error
structure (JSON). 

However, the 401 error above is indistinguishable from a proper call, but the token has
become invalid.



## Error Catalog

orcid-invalid-token

authorization against the orcid api with the orcid link token failed
this would be a 401 error from ORCID, meaning lack of valid authentication with the token
probably means the user has removed permission for KBase, or the token was otherwise revoked,
as the tokens last for 20 years.


The user should be given the opportunity to delete their ORCID Link and then recreate it. 


## Weird Error Conditions

### 1011: Parent token is disabled

```json
{
    "jsonrpc": "2.0",
    "error": {
        "code": 1011,
        "message": "Not Authorized",
        "data": "Parent token is disabled"
    },
    "id": "123"
}
```

This error indicates that the access_token (?) has been revoked, and a refresh has been
attempted.

This should not occur under normal conditions.

Try reproducing:

Directly, as an admin, to observe API behavior:

- create a link
- remove authorization at ORCID
- use the admin refresh-tokens method.

or 

Indirectly, as a user, to observe API and UI behavior:

- create a link
- remove authorization at ORCID
- set the retirement date to some time in the past (to trigger a refresh) 
- pull up the oricdlink ui 

TODO:

this should not be a general "not authorized" exception, which applies to the KBase
authorization.

For an ORCID "not authorized" we need another code. 

The reason is that an ORCID not-authorized cannot be recovered from other than deleting
and recreating the link. A KBase not-authorized means the user needs to either log in
(and is accessing the orcidlink api w/out a token) or the KBase token has expired or
been revoked in another session. Just very different recovery scenarios that need to be
distinguished.
